{% extends 'root/base.html' %}
{% load static %}
{% block title %} Favourite Transaction Types (Application Settings) {% endblock %}
{% block maincontent %}



    <div class="container-fluid">
        <div class="configuration-table_wrapper">
            <div class="elements-space-between">
                <h3>Maintain Favourite Transaction Types</h3>
                <div>
                <button type="button" id="id_add_data" title="ADD" value="ADD"  class="btn btn-primary display_buttons " data-toggle="modal" data-target="#myModal" onclick="onclick_add_button(this)">
                    <i class="fa fa-plus"></i> Add Favourite Transaction Type
                </button>
                    <button class="btn btn-outline-secondary" id="id_close" value="close" title="Close"  onclick="GetReferrer();">
                    <i class="fas fa-times"></i> close
                </button>
                </div>
        </div>
            <hr>
            <div class="configuration-table_section">
            <div id="err_msg_app_settings"> </div>
            <div id="err_msg_app_settings_t" class="alert alert-success" hidden> <span id="success_msg_id"></span></div>

            <div class="table-container tcw-80">
                <div class="edit-button-section mb-4">
                    <button class="btn btn-secondary btn-sm" title="Edit" id="id_edit_data" onclick="onclick_edit_button()">
                        <i class="fas fa-edit"></i> edit
                    </button>
                   <button class="btn btn-outline-danger btn-sm" id="id_delete_data" value="transaction_types_delete" style="display:none;" data-toggle="modal" data-target="#id_delete_confirm_popup">
                        <i class="fa fa-trash" aria-hidden="true" title="Delete Line"></i> delete
                    </button>

                    <!-- <button class="btn btn-primary btn-sm"  title="Copy" id="id_copy_data" style="display:none;" value="COPY"  type="button" onclick="onclick_copy_button()">
                        <i class="fa fa-copy"></i> copy
                    </button> -->

                    <button class="btn btn-primary btn-sm" title="Update" id="id_update_data" style="display:none;" value="UPDATE"  type="button" onclick="onclick_update_button()">
                        <i class="far fa-edit"></i> update
                    </button>
                    <button  class="btn btn-secondary btn-sm" title="Cancel" id="id_cancel_data" style="display:none;" type="button" onclick="display_basic_db_data()">
                        <i class="fas fa-times"></i> cancel
                    </button>
                </div>
                <table id="display_basic_table" class="class_basic_transaction_types_table table table-bordered custom-table">
                    <thead id="id_transaction_types_table_header">
                        <tr>
                            <th id="hg_select_checkbox" hidden>
                                <div id="id_check_all" style="display:none;">
                                    <INPUT type="checkbox" onchange="checkAll(this)" name="chk[]">
                                </div>

                            </th>
                            <th>Transaction Type</th>
                            <th>Description</th>
                            <th>Document Type</th>
                            <th>Sequence</th>
                            <th>Active/Inactive</th>
                            <th hidden>guid</th>
                            <th hidden>del_ind</th>
                        </tr>
                    </thead>
                    <tbody id="id_transaction_types_tbody">
                        {% for transaction_types in transaction_type %}
                        <tr>
                            <td class="class_select_checkbox" hidden><input type="checkbox" class="checkbox_check" onclick="valueChanged()" required></td>
                            <td>{{transaction_types.transaction_type}}</td>
                            <td>{{transaction_types.description}}</td>
                            <td>{{transaction_types.document_type}}</td>
                            <td>{{transaction_types.sequence}}</td>
                            <td>{{transaction_types.active_inactive}}</td>
                            <td hidden>{{transaction_types.guid}}</td>
                            <td hidden>{{transaction_types.del_ind}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<!--<button style="display:none;" class="btn btn-primary  modal_upload" id="id_upload_redirect_transaction_types" value="transaction_types_upload" onclick="onclick_upload_button()" type="button"><i class="fas fa-cloud-upload-alt"></i> DATA UPLOAD </button>-->
<!--end of display basic Transaction Type table-->
       
                <!-- The Modal -->
            <div class="modal fade" id="myModal" style="overflow:auto;">
                <div class="modal-dialog modal-dialog-centered modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="update-countries-title"> Maintain Favourite Transaction Type</h5>
                            <button type="button" class="close remove_upload_data" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                       <!-- Modal body -->
                        <div class="modal-body scrollbox">
                           
                                <div id="id_del_add_button" class="mb-4">
                                    <button class="btn btn-primary" type="button" onclick="add_popup_row()">
                                        <i class="fa fa-plus"></i> add new row
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="application_settings_delete_Row('id_popup_table')">
                                        <i class="fa fa-trash"></i> delete
                                    </button>
                                </div>
                        
                            <div id="id_check_success_messages" class="alert alert-success check_success_message" hidden></div>
                            <div id="id_check_error_messages" class="alert alert-danger check_error_messages" hidden></div>
                            <div id="id_check_special_character_messages" class="alert alert-danger check_special_character_messages" hidden>
                                <p id="id_error_msg_transaction_types_code"></p>
                                <p id="id_error_msg_transaction_types_name"></p>
                                <p id="id_error_msg_transaction_types_length"></p>
                            </div>
                            <div id="error_msg_id" class="alert alert-danger display-none" role="alert"><span id="error_message"></span></div>
                            <div id="id_warning_msg_id" class="alert alert-warning display-none" role="alert"></div>
                            <div id="id_info_msg_id" class="alert alert-primary display-none" role="alert"></div>
        


                            <table class="class_popup_table  table table-bordered mt-2"  id="id_popup_table">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>Transaction Type</th>
                                        <th>Description</th>
                                        <th>Document Type</th>
                                        <th>Sequence</th>
                                        <th>Active/Inactive</th>
                                        <TH hidden>GUID</TH>
                                        <th id="id_del_ind_checkbox" hidden>Del Indicator</th>
                                    </tr>
                                </thead>
                                <tbody id=id_popup_tbody>

                                </tbody>
                            </table>

                        </div>

                        <!-- Modal footer -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-primary remove_upload_data" data-dismiss="modal"><i class="fas fa-times"></i> cancel</button>
                            <button id="id_delete_duplicate" class="btn btn-primary" style="display:none;" type="button" onclick="delete_duplicate()"><i class="fa fa-trash"></i> delete duplicates</button>
                            <button id="id_check_data" style="display:none;" class="btn btn-primary" type="button" onclick="check_data()"><i class="fas fa-check"></i> check</button>
                            <button class="btn btn-primary" id="save_id"><i class="fas fa-save"></i> save</button>
                           
                        </div>
                    </div>
                </div>
            </div>
        
        <!--end of modal popup for Add,copy,update and upload-->
        {% include 'configuration_common_pop_up.html' %}
        <div>
            {% if messages %} {% for message in messages %} {% if message.tags == 'success' %}
            <div style="color: green; ">{{ message }}</div>
            {% endif %} {% if message.tags == 'error' %}
            <div style="color: red; ">{{ message }}</div>
            {% endif %} {% if message.tags == 'info' %}
            <div style="color: Black bold"><b>{{ message }}</b> </div>
            {% endif %} {% endfor %} {% endif %}
        </div>
    </div>

{{ transaction_type|json_script:"transaction_type" }}

    <script>
       
        var rendered_transaction_types_data = JSON.parse(document.getElementById('transaction_type').textContent);
        var rendered_document_type = {{document_type|safe}};
        var rendered_active_inactive = {{rendered_active_inactive|safe}};
        var rendered_active_inactive_onload = {{rendered_active_inactive_onload|safe}};
        var rendered_sequence = {{upload_numberrange|safe}};
        var transaction_types_data_array = {}
        var main_table_transaction_types_value = [];
        var transaction_types = '';
        var edit_basic_data = '';
        var GLOBAL_ACTION = '';
        var no_duplicate_entries = 'Y'
        var Tablename = uiConstants["CONST_TABLENAME_TRANSACTION_TYPES"]
        var appname = uiConstants["CONST_APPNAME01"]
        var db_header_data = uiConstants["CONST_HEADER_DATA_TRANSACTION_TYPES"]
        //*********************************
        var doc_type_dropdown = '';
        var sequence_dropdown = '';


        var active_inactive_dropdown = '';
        function dropdown_value(){
        active_inactive_dropdown = '';
        $.each(rendered_active_inactive, function(i, item){
             active_inactive_dropdown += '<option value="' + item.field_type_id + '">' + item.field_type_id + '</option>';
        });
        }


        var active_inactive_dropdown_onload = '';
        $.each(rendered_active_inactive_onload, function(i, item){
             active_inactive_dropdown_onload += '<option value="' + item.field_type_id + '">' + item.field_type_id + '</option>';
        });

        var document_type_dropdown= '';
        $.each(rendered_document_type, function(i, item){
            document_type_dropdown += '<option value="' + item.document_type + '">' + item.document_type + '</option>';
        });


        var rendered_sequence_array =[];
        var sequence_remove_array = [];



 // validate and save for add,copy,update and upload data
        function popup_save_data() {
            $('#success_msg_id').empty()
            $('#id_popup_table').DataTable().destroy();
            var main_table_low_value = [];
            no_duplicate_entries = 'Y'
            no_duplicate_value = 'Y'
            var error_message = '';
<!--            //var transaction_type = {}-->
            $('#display_basic_table').DataTable().destroy();
            $("#display_basic_table TBODY TR").each(function() {
                var row = $(this);
                var main_attribute = {};
                main_attribute.transaction_type = row.find("TD").eq(2).html();
                main_table_low_value.push(main_attribute.transaction_type);
            });
            table_sort_filter('display_basic_table');

            [no_duplicate_value,error_message] = compare_table_for_duplicate_entries(validate_add_attributes, transaction_types_data)
            if (error_message){
                display_error_message(error_message)
            }
            else{
                if ((GLOBAL_ACTION == "COPY") || (GLOBAL_ACTION == "ADD")) {
                    [no_duplicate_entries,error_message] = maintable_validation(validate_add_attributes, main_table_low_value)
                }
                if ((no_duplicate_value == 'Y') && (no_duplicate_entries == 'Y')) {
                    var add_basic_data = '';
                    var transaction_types_data_array = transaction_types_data;
                 
                    $('#id_save_confirm_popup').modal('hide');

                data = {'data':transaction_types_data,'table_name':'TransactionTypes','action':GLOBAL_ACTION}
 
                $.ajax({
                    type: 'POST',
                    url: "{% url 'eProc_Configuration:create_update_application_data' %}",
                    data: JSON.stringify(data),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function(Response) {
                        rendered_transaction_types_data = Response[0];
                        rendered_active_inactive = Response[2];
                        display_basic_db_data();
                        dropdown_value();
                        $('#myModal').modal('hide');
                        $('#id_error_msg').text(messageConstants["JMSG001"])
                         $('#success_msg_id').text(Response[1])
                        $("#err_msg_app_settings_t").prop("hidden", false)
                        table_sort_filter('id_popup_table');
                        setTimeout(function() {
                            $("#err_msg_app_settings_t").prop("hidden", true);
                        }, 5000)
                        table_sort_filter('id_popup_table');
                    }
                });

            }
            else if (error_message){
                display_error_message(error_message)
        }
    }
}
  

//delete the selected row in db................

        var main_table_transaction_types_checked = [];
        function main_table_delete() {
            $('#success_msg_id').empty()
            GLOBAL_ACTION = 'DELETE'
            main_table_transaction_types_checked = [];
            
            $('#display_basic_table').DataTable().destroy();
            $("#display_basic_table TBODY TR").each(function() {
                var row = $(this);
                var status;
                var transaction_types_arr_obj = {};

                transaction_types_arr_obj.del_ind = row.find("TD").eq(0).find('input[type="checkbox"]').is(':checked');

                if( transaction_types_arr_obj.del_ind){
                    transaction_types_arr_obj.transaction_type = row.find("TD").eq(1).html();
                    transaction_types_arr_obj.description = row.find("TD").eq(2).html();
                    transaction_types_arr_obj.document_type = row.find("TD").eq(3).html();
                    transaction_types_arr_obj.sequence = row.find("TD").eq(4).html();
                    if (row.find("TD").eq(5).html() == 'Active')
                    status = 1;
                    else
                    status = 0;
                    transaction_types_arr_obj.active_inactive = status;
                    console.log(transaction_types_arr_obj.active_inactive);
                    transaction_types_arr_obj.del_ind = row.find("TD").eq(0).find('input[type="checkbox"]').is(':checked');
                    transaction_types_arr_obj.guid = row.find("TD").eq(6).html();
                   main_table_transaction_types_checked.push(transaction_types_arr_obj);
                }
            });
            $('#id_delete_confirm_popup').modal('hide');
            data = {'data':main_table_transaction_types_checked,'table_name':'TransactionTypes','action':GLOBAL_ACTION}
            $.ajax({
                type: 'POST',
                url: "{% url 'eProc_Configuration:create_update_application_data' %}",
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(Response) {
                    console.log(Response);
                    rendered_transaction_types_data = Response[0];
                    rendered_active_inactive = Response[2];
                    display_basic_db_data();
                    $('#success_msg_id').text(Response[1])
                    $("#err_msg_app_settings_t").prop("hidden",false)
                    setTimeout(function() {
                        $("#err_msg_app_settings_t").prop("hidden", true);
                    }, 5000)
                }
            });
        }
        //*************************

        //check function restricting special char and diaplay the data count of csv file
        function check_data() {
            $('#id_popup_table').DataTable().destroy();
            $("#id_check_success_messages").empty()
            $("#id_check_error_messages").empty()
            $("#id_check_success_messages").prop("hidden", true)
            $("#id_check_error_messages").prop("hidden", true)
            $("#id_check_special_character_messages").prop("hidden", true)
            document.getElementById("id_error_msg_transaction_types_code").innerHTML = "";
            document.getElementById("id_error_msg_transaction_types_name").innerHTML = "";
            document.getElementById("id_error_msg_transaction_types_length").innerHTML = "";
            count = 0;
            var transaction_types_array = new Array
            var DB_array = new Array
            var transaction_types_list = new Array
            var transaction_types_code_check = new Array
            var Duplicate_count = 0
            del_ind = ''
            $("#id_popup_table TBODY TR").each(function() {
                var row = $(this);

                //*************** reading data from the pop-up ***************
                del_ind = row.find("TD").eq(7).find('input[type="checkbox"]').is(':checked');
                document_type = row.find("TD").eq(1).find("select option:selected").val();
                transaction_type = row.find("TD").eq(2).find('input[type="text"]').val().toUpperCase();
                description = row.find("TD").eq(3).find('input[type="text"]').val().toUpperCase();
                sequence = row.find("TD").eq(4).find("select option:selected").val();
                active_inactive = row.find("TD").eq(5).find("select option:selected").val();
                guid = row.find("TD").eq(6).find('input[type="text"]').val();

                transaction_types_list.push([document_type, transaction_type, sequence, active_inactive, guid, del_ind])

                var format = /[`!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/;


                //*************** checking for max length for transaction_types code (max length = 6) ***************
                if (transaction_type.length > 6) {
                    document.getElementById("id_error_msg_transaction_types_length").innerHTML = messageConstants["JMSG004"] + "Transaction Type";
                    $(row.find("TD").eq(1).find('input[type="text"]')).css("border", "1px solid #FF0000");
                    count = count + 1;
                }

                //*************** checking for special characters for transaction_types code ***************
                else if (format.test(transaction_type)) {
                    document.getElementById("id_error_msg_transaction_types_code").innerHTML = messageConstants["JMSG003"] + "Transaction Type";
                    $(row.find("TD").eq(1).find('input[type="text"]')).css("border", "1px solid #FF0000");
                    count = count + 1;
                } else {
                    $(row.find("TD").eq(1).find('input[type="text"]')).css("border", "none");
                }

                //*************** checking for special characters for transaction_types name ***************
                if (format.test(description)) {
                    document.getElementById("id_error_msg_transaction_types_name").innerHTML = messageConstants["JMSG003"] + "Description";
                    $(row.find("TD").eq(2).find('input[type="text"]')).css("border", "1px solid #FF0000");
                    count = count + 1;
                } else {
                    $(row.find("TD").eq(2).find('input[type="text"]')).css("border", "none");
                }

                if (transaction_types_code_check.includes(transaction_type)) {
                    $(row).css("border", "#f8d7da");
                    //$(row.find("TD").eq(1).find('input[type="text"]')).css("border", "1px solid #FF0000");
                    //$(row.find("TD").eq(2).find('input[type="text"]')).css("border", "1px solid #FF0000");
                    Duplicate_count = Duplicate_count +1;

                } else {
                    $(row).css("border", "");
                }

                transaction_types_code_check.push(transaction_type)
            });

            //*************** shows save button if there are no errors(special characters and max length) ***************
            if (count == 0) {
                $("#id_check_special_character_messages").prop("hidden", true)
                $("#save_id").prop("hidden", false);
            }
            popup_data_dict = {
                'data_list': transaction_types_list,
                'Tablename': Tablename,
                'appname': appname,
                'db_header_data': db_header_data
            }
            $.ajax({
                type: 'POST',
                url: "{% url 'eProc_Configuration:check_data_fk' %}",
                data: JSON.stringify(popup_data_dict),
                success: function(response) {
                    table_sort_filter_popup_pagination('id_popup_table')
                    $("#id_check_special_character_messages").prop("hidden", false)
                    if (count == 0) {
                        $("#id_check_special_character_messages").prop("hidden", true)
                    }

                    //*************** retrieving data counts from views ***************
                    check_messages = response
                    var newArrayDataOfOjbect = Object.values(check_messages)
                    $("#id_check_success_messages").prop("hidden", false)

                    //*************** if pop-up data count is greater than zero ***************
                    if (newArrayDataOfOjbect[1] > 0) {
                        $("#id_check_success_messages").append('<p>' + messageConstants["JMSG010"] + newArrayDataOfOjbect[0] + '</p>')
                        $("#id_check_success_messages").append('<p>' + messageConstants["JMSG011"] + newArrayDataOfOjbect[1] + '</p>')
                        $("#id_check_success_messages").append('<p>' + messageConstants["JMSG012"] + newArrayDataOfOjbect[3] + '</p>')
                        $("#id_check_success_messages").append('<p>' + messageConstants["JMSG013"] + newArrayDataOfOjbect[4] + '</p>')
                        $("#id_check_success_messages").append('<p>' + messageConstants["JMSG014"] + newArrayDataOfOjbect[5] + '</p>')

                        //*************** if duplicate data data count is greater than zero ***************
                        if (Duplicate_count > 0) {
                            $("#id_check_error_messages").prop("hidden", false)
                            $("#id_check_error_messages").append('<p>' + messageConstants["JMSG015"] + Duplicate_count + '</p>')
                            $("#id_check_error_messages").append('<p style = "font-weight: bold;">' + messageConstants["JMSG001"] + ' </p>')
                            $("#save_id").prop("hidden", true);
                            $("#id_delete_duplicate").show()
                        } else {
                            $("#id_check_error_messages").prop("hidden", true)
                            $("#id_delete_duplicate").hide()
                        }
                    }
                    //*************** if pop-up data count is zero ***************
                    else {
                        $("#id_check_success_messages").hide()
                        $("#id_check_error_messages").prop("hidden", false)
                        $("#id_check_error_messages").append('<p>' + messageConstants["JMSG006"] + '</p>')
                        $("#save_id").prop("hidden", true);
                    }
                }
            });
        }

        //onclick of cancel display the table in display mode............
function display_basic_db_data() {
    $('#display_basic_table').DataTable().destroy();
    $('#id_transaction_types_tbody').empty();
    var edit_basic_data = '';
    $.each(rendered_transaction_types_data, function (i, item) {
        edit_basic_data += '<tr ><td class="class_select_checkbox"><input class="checkbox_check" onclick="valueChanged()" type="checkbox" required></td><td>' + item.transaction_type + '</td><td>' + item.description + '</td><td>' + item.document_type + '</td><td>' + item.sequence + '</td><td>' + item.active_inactive + '</td><td hidden>' + item.guid + '</td><td hidden>' + item.del_ind + '</td></tr>';
        sequence_remove_array.push(item.sequence)
    });
    $('#id_transaction_types_tbody').append(edit_basic_data);
    $("#hg_select_checkbox").prop("hidden", true);
    $(".class_select_checkbox").prop("hidden", true);
    $('input:checkbox').removeAttr('checked');
    $('#id_edit_data').show();
    $('#id_cancel_data').hide();
    //document.getElementById("id_upload_redirect_transaction_types").style.display = "none";
    $("#id_delete_data").hide();
    $("#id_copy_data").hide();
    $("#id_update_data").hide();
    $("#id_save_confirm_popup").hide();
    $("#id_delete_confirm_popup").hide();
    $('#id_check_all').hide();
    table_sort_filter('display_basic_table');
}

//***************************
//**********************************************
       function GetReferrer() {
             window.history.back();
              var preUrl = document.referrer;
              console.log(preUrl);
              window.open('', '_self', '').close();
<!--               var win = window.open(preUrl);-->
<!--                win.focus();-->
              if (preUrl == null)
                     return "The previous page url is empty";
               else
                     return preUrl;
       }

       
    </script>
    <script src="{% static 'scripts/transaction_type.js' %}"></script>
   
{% endblock %}